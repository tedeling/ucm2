@main("Data Import administration", ImportAdmin) {
<div class="page-header"><h1>Data Import administration</h1></div>

<div class="row">
    <div class="span6">
        <h2>Trigger</h2>
        Trigger an immediate data import of CDR and ACD data from your router.
        <br/>
        When an import is currently running this trigger will be ignored.
        <br/>
        <div id="importAlreadyRunning" style="display:none;" class="alert alert-info">
            An import is already running, this trigger will be ignored.
        </div>
        <div id="importRunningPlaceholder"><br /></div>

        <button class="btn btn-primary" id="trigger_import">
            <i class="icon-refresh"></i>
            Trigger import
        </button>

        <br/>
        <br/>
        <br/>

        <h2>Configure</h2>
        Configure the stuff here
        <br/>
        When an import is currently running this trigger will be ignored.
        <br/>
        <br/>

        <a class="btn btn-primary" href="http://localhost:9000/trigger_import">
            <i class="icon-wrench"></i>
            Configure</a>
    </div>

    <div class="span6">
        <h2>Status</h2>

        <div class="well">
            <div class="row">
                <table style="margin-left:20px" id="withStatus" style="display:none">
                    <tbody>
                    <tr>
                        <td>Currently:</td>
                        <td id="status">idle</td>
                    </tr>

                    <tr>
                        <td id="duration">Last run:</td>
                        <td id="durationValue">2012-08-09 23:20 - 2012-08-09 23:20</td>
                    </tr>

                    <tr>
                        <td>CDR's found:</td>
                        <td id="cdr">3000</td>
                    </tr>

                    <tr>
                        <td>VSA's found:</td>
                        <td id="vsa">4000</td>
                    </tr>

                    <tr>
                        <td>Duplicates:</td>
                        <td id="dupes">2000</td>
                    </tr>
                    </tbody>
                </table>

                <div id="noStatus" style="margin-left: 20px;display:none">
                    No import yet.
                </div>
            </div>
        </div>

        <br/>

        <h2>Statistics</h2>

        <div class="well">
            <div class="row">
                <div style="float:right"><i class="icon-refresh"></i></div>
                <table style="margin-left:20px">
                    <tbody>
                    <tr>
                        <td>CDR in db:</td>
                        <td>3000</td>
                    </tr>

                    <tr>
                        <td>VSA in db:</td>
                        <td>6000</td>
                    </tr>
                    </tbody>
                </table>

            </div>
        </div>
    </div>
</div>


<script type="text/javascript">
    $(document).ready(function () {
        $("#trigger_import").click(function () {
            $("#trigger_import").removeClass("btn-primary");

            window.setTimeout(function () {
                $("#trigger_import").addClass("btn-primary");
            }, 2000);


            $.get("/import/trigger")
                .error(function () {
                    $("#importAlreadyRunning").show();
                    $("#importRunningPlaceholder").hide();
                    $("#importAlreadyRunning").delay(2000).hide(500);
                    $("#importRunningPlaceholder").delay(2000).show(500);
                });
        })


        update_status();
    });

    update_status = function () {

        $.ajax({
            url: '/import/status',
            dataType: 'json',
            success: function( statusObj, status, xhr ) {
                if (xhr.status == 200) {
                    var finished = (statusObj.finished === 'true');
                    var startTime = statusObj.start
                    var endTime = statusObj.end

                    if (finished) {
                        $("#status").text("finished");
                        $("#duration").text("Last run:");
                        $("#durationValue").text(startTime + " - " + endTime);

                    } else {
                        $("#status").text("running");
                        $("#duration").text("Start time:");
                        $("#durationValue").text(startTime);
                    }

                    $("#cdr").text(statusObj.cdr);
                    $("#vsa").text(statusObj.vsa);
                    $("#dupes").text(statusObj.dupes);

                    $("#withStatus").show();
                    $("#noStatus").hide();

                    window.setTimeout(update_status, !finished ? 500 : 1000)
                } else {
                    $("#withStatus").hide();
                    $("#noStatus").show()
                    window.setTimeout(update_status, 1000)
                }
            }
        });
    }
</script>
}